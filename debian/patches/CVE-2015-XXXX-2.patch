From fe88375753d8101bb8e4ad62dafd89a406335d10 Mon Sep 17 00:00:00 2001
From: Alan Coopersmith <alan.coopersmith@oracle.com>
Date: Fri, 6 Feb 2015 15:54:00 -0800
Subject: [PATCH:libXfont 2/3] bdfReadCharacters: bailout if a char's bitmap
 cannot be read [CVE-2015-BBBB]

Previously would charge on ahead with a NULL pointer in ci->bits, and
then crash later in FontCharInkMetrics() trying to access the bits.

Found with afl-1.23b.

Signed-off-by: Alan Coopersmith <alan.coopersmith@oracle.com>
Reviewed-by: Julien Cristau <jcristau@debian.org>
---
 src/bitmap/bdfread.c |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

Index: libxfont-1.4.1/src/bitmap/bdfread.c
===================================================================
--- libxfont-1.4.1.orig/src/bitmap/bdfread.c	2015-03-27 12:54:30.000000000 +0100
+++ libxfont-1.4.1/src/bitmap/bdfread.c	2015-03-27 12:54:30.000000000 +0100
@@ -460,7 +460,10 @@
 	    ci->metrics.descent = -bb;
 	    ci->metrics.characterWidth = wx;
 	    ci->bits = NULL;
-	    bdfReadBitmap(ci, file, bit, byte, glyph, scan, bitmapsSizes);
+	    if (!bdfReadBitmap(ci, file, bit, byte, glyph, scan, bitmapsSizes)) {
+		bdfError("could not read bitmap for character '%s'\n", charName);
+		goto BAILOUT;
+	    }
 	    ci++;
 	    ndx++;
 	} else
